
{% extends 'chat/base.html' %}
{% block title %}Room: {{ room_name }}{% endblock %}

{% block extra_css %}
    #chat-log { height:450px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; background-color: #fcfcfc; display: flex; flex-direction: column; gap: 10px; border-radius: 8px; }
    .message { padding: 8px 12px; background: #fff; border-radius: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); width: fit-content; max-width: 85%; word-wrap: break-word; }

    .message.me { align-self: flex-end; background-color: #81000f; border-bottom-right-radius: 2px; color: white; }
    .message.me .username { color: #e0e0e0; }
    .message.me .content { color: white; }

    .message.other { align-self: flex-start; background-color: #050027; border-bottom-left-radius: 2px; color: white; }
    .message.other .username { color: #ffe0e0; }
    .message.other .content { color: white; }

    .tick { font-size: 0.9em; margin-left: 5px; color: #aaa; }
    
    .username { font-weight: bold; display: block; font-size: 0.85em; }
    .timestamp { font-size: 0.7em; display: block; margin-top: 5px; opacity: 0.8; text-align: right; }
{% endblock %}

{% block content %}
    <h2>Room: {{ room_name }}</h2>
    <div id="chat-log">
        {% for msg in messages %}
            <div class="message {% if msg.user == request.user %}me{% else %}other{% endif %}">
                <span class="username">{{ msg.user.username }}</span>

                {% if msg.image %}
                    <img src="{{ msg.image.url }}" style="max-width: 250px; border-radius: 10px; margin: 10px 0; display: block; cursor: pointer;" onclick="window.open('{{ msg.image.url }}')">
                {% endif %}

                {% if msg.content %}
                <span class="content">{{ msg.content|urlize }}</span>
                {% endif %}
                
                <span class="timestamp">{{ msg.timestamp|date:"h:i A" }}</span>
            </div>
        {% endfor %}
    </div>

    <div id="online-users-container" style="margin-bottom: 10px; padding: 10px; background: #eef; border-radius: 8px;">
        <div id="typing-indicator" style="font-size: 0.8em; color: gray; height: 20px; margin-left: 10px;"></div>
        <strong>Online Users:</strong>
        <ul id="online-users-list" style="display: flex; gap: 10px; list-style: none; padding: 0; margin-top: 5px;"></ul>
    </div>

    <br>
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="file" id="chat-file-input" style="display: none;" accept="image/*">
        <label for="chat-file-input" style="cursor: pointer; font-size: 1.5em; color: #5887ff;">üì∑</label>

        <input id="chat-message-input" type="text" style="flex-grow: 1; padding: 10px;" placeholder="Type message...">
        <input id="chat-message-submit" type="button" value="Send" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer;">
    </div>

    {{ room_name|json_script:"room-name" }}





    <script>
        
    function urlify(text) {
        if (!text) return "";
        var urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, function(url) {
            return '<a href="' + url + '" target="_blank" style="color: #5887ff; text-decoration: underline;">' + url + '</a>';
        });
    }

    const roomName = JSON.parse(document.getElementById('room-name').textContent);
    const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + roomName + '/');
    const messageInputDom = document.querySelector('#chat-message-input');
    const typingDiv = document.querySelector('#typing-indicator');

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const currentUser = "{{ request.user.username }}";

        // ‡ßß. ‡¶ü‡¶æ‡¶á‡¶™‡¶ø‡¶Ç ‡¶á‡¶®‡ßç‡¶°‡¶ø‡¶ï‡ßá‡¶ü‡¶∞
        if (data.type === 'typing' && data.username !== currentUser) {
            typingDiv.innerText = data.username + ' is typing...';
            if (window.typingTimer) clearTimeout(window.typingTimer);
            window.typingTimer = setTimeout(() => { typingDiv.innerText = ''; }, 2000);
            return;
        }

        // ‡ß®. ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü
        if (data.type === 'user_list') {
            const listElement = document.querySelector('#online-users-list');
            if (listElement) {
                listElement.innerHTML = ''; 
                data.users.forEach(user => {
                    const li = document.createElement('li');
                    li.style.cssText = "background: #d4edda; padding: 2px 8px; border-radius: 15px; font-size: 0.8em; border: 1px solid #c3e6cb;";
                    li.innerHTML = `‚óè ${user}`;
                    listElement.appendChild(li);
                });
            }
            return; 
        }
        
        // ‡ß©. ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶è‡¶¨‡¶Ç ‡¶á‡¶Æ‡ßá‡¶ú ‡¶∞‡¶ø‡¶∏‡¶ø‡¶≠
        if (data.type === 'chat_message') {
            const chatLog = document.querySelector('#chat-log');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${data.username === currentUser ? 'me' : 'other'}`;
            messageDiv.id = `msg-${data.message_id}`;

            let contentHTML = `<span class="username">${data.username}</span>`;

            // ‡¶á‡¶Æ‡ßá‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ö‡ßá‡¶ï
            if (data.image_url) {
                contentHTML += `<img src="${data.image_url}" style="max-width: 250px; border-radius: 10px; margin: 10px 0; display: block; cursor:pointer;" onclick="window.open('${data.image_url}')">`;
            } 
            
            if (data.message) {
                contentHTML += `<span class="content">${urlify(data.message)}</span>`;
            }

            contentHTML += `
                <span class="timestamp">
                    ${data.timestamp}
                    <span class="tick" id="tick-${data.message_id}">
                        ${data.username === currentUser ? '‚úì' : ''}
                    </span>
                </span>`;
            
            messageDiv.innerHTML = contentHTML;
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;

            // ‡ß™. ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶∞‡¶ø‡¶° ‡¶∏‡¶ø‡¶ó‡¶®‡ßç‡¶Ø‡¶æ‡¶≤ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
            if (data.username !== currentUser && data.message_id) {
                chatSocket.send(JSON.stringify({
                    'type': 'message_read',
                    'message_id': data.message_id
                }));
            }
        }
        
        // ‡ß´. ‡¶∞‡¶ø‡¶° ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü (Double Tick)
        if (data.type === 'message_read') {
            const tickElement = document.querySelector(`#tick-${data.message_id}`);
            if (tickElement) {
                tickElement.innerHTML = '‚úì‚úì'; 
                tickElement.style.color = '#3498db'; 
            }
        }
    }; // onmessage ends here

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    messageInputDom.focus();

    messageInputDom.onkeyup = function(e) {
        if (e.keyCode === 13) {
            document.querySelector('#chat-message-submit').click();
        } else {
            chatSocket.send(JSON.stringify({ 'type': 'typing' }));
        }
    }

    document.querySelector('#chat-message-submit').onclick = function(e){
        const message = messageInputDom.value;
        if (message.trim() !== ""){
            chatSocket.send(JSON.stringify({'message': message}));
            messageInputDom.value = '';
        }
    };

    // ‡¶á‡¶Æ‡ßá‡¶ú ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞
    const fileInput = document.querySelector('#chat-file-input');
    fileInput.onchange = function(e) {
        const file = fileInput.files[0];
        if (!file) return;

        if (file.size > 5 * 1024 * 1024) {
            alert("File is too large! Please upload under 5MB.");
            return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
            chatSocket.send(JSON.stringify({
                'type': 'file',
                'file_data': event.target.result,
                'file_name': file.name
            }));
        };
        reader.readAsDataURL(file);
        fileInput.value = ''; // ‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶§‡ßá ‡¶è‡¶ï‡¶á ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡ßü
    };
</script>
{% endblock %}

