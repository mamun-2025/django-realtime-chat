
{% extends 'chat/base.html' %}
{% block title %}Room: {{ room_name }}{% endblock %}

{% block extra_css %}
    /* আপনার দেওয়া CSS গুলো এখানে বসবে */
    #chat-log { height:450px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; background-color: #fcfcfc; display: flex; flex-direction: column; gap: 10px; border-radius: 8px; }
    .message { padding: 8px 12px; background: #fff; border-radius: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); width: fit-content; max-width: 85%; word-wrap: break-word; }

    .message.me { align-self: flex-end; background-color: #5887ff; border-bottom-right-radius: 2px; }
    .message.me .username { color: #e0e0e0; }
    .message.me .content { color: white; }

    .message.other { align-self: flex-start; background-color: #fd6666; border-bottom-left-radius: 2px; }
    .message.other .username { color: #ffe0e0; }
    .message.other .content { color: white; }
    
    .username { font-weight: bold; color: #2c3e50; display: block; font-size: 0.85em; }
    .content { color: #34495e; }
{% endblock %}

{% block content %}
    <h2>Room: {{ room_name }}</h2>
    <div id="chat-log">
        {% for msg in messages %}
            <div class="message {% if msg.user == request.user %}me{% else %}other{% endif %}">
                <span class="username">{{ msg.user.username }}</span>
                <span class="content">{{ msg.content }}</span>
            </div>
        {% endfor %}
    </div>
    <br>
    <input id="chat-message-input" type="text" style="width: 80%; padding: 10px;" placeholder="Type message...">
    <input id="chat-message-submit" type="button" value="Send" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer;">

    {{ room_name|json_script:"room-name" }}

    <script>
        const roomName = JSON.parse(document.getElementById('room-name').textContent);
        const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + roomName + '/');

        chatSocket.onmessage = function(e){
            const data = JSON.parse(e.data);
            const chatLog = document.querySelector('#chat-log');

            const currentUser = "{{ request.user.username }}";

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');

            if (data.username === currentUser){
                messageDiv.classList.add('me');
            } else {
                messageDiv.classList.add('other');
            }
            
            messageDiv.innerHTML = `<span class="username">${data.username}</span><span class="content">${data.message}</span>`;
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        };

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-submit').onclick = function(e){
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            if (message.trim() !== ""){
                chatSocket.send(JSON.stringify({'message': message}));
                messageInputDom.value = '';
            }
        };
    </script>
{% endblock %}