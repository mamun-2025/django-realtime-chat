
{% extends 'chat/base.html' %}
{% block title %}Room: {{ room_name }}{% endblock %}

{% block extra_css %}
    #chat-log { height:450px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; background-color: #fcfcfc; display: flex; flex-direction: column; gap: 10px; border-radius: 8px; }
    .message { padding: 8px 12px; background: #fff; border-radius: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); width: fit-content; max-width: 85%; word-wrap: break-word; }

    .message.me { align-self: flex-end; background-color: #81000f; border-bottom-right-radius: 2px; color: white; }
    .message.me .username { color: #e0e0e0; }
    .message.me .content { color: white; }

    .message.other { align-self: flex-start; background-color: #050027; border-bottom-left-radius: 2px; color: white; }
    .message.other .username { color: #ffe0e0; }
    .message.other .content { color: white; }

    .tick { font-size: 0.9em; margin-left: 5px; color: #aaa; }
    
    .username { font-weight: bold; display: block; font-size: 0.85em; }
    .timestamp { font-size: 0.7em; display: block; margin-top: 5px; opacity: 0.8; text-align: right; }
{% endblock %}

{% block content %}
    <h2>Room: {{ room_name }}</h2>
    <div id="chat-log">
        {% for msg in messages %}
            <div class="message {% if msg.user == request.user or msg.sender == request.user %}me{% else %}other{% endif %}">
                <span class="username">{{ msg.user.username }}</span>

                {% if msg.image %}
                    <img src="{{ msg.image.url }}" style="max-width: 250px; border-radius: 10px; margin: 10px 0; display: block; cursor: pointer;" onclick="window.open('{{ msg.image.url }}')">
                {% endif %}

                {% if msg.content %}
                <span class="content">{{ msg.content|urlize }}</span>
                {% endif %}

                {% if msg.audio %}
                    <audio controls sytle="max-width: 100%; margin-top: 5px; display: block;">
                        <source src="{{ msg.audio.url }}" type="audio/wav">
                        Your browser does not support the audio element.
                    </audio>
                {% endif %}
                
                <span class="timestamp">{{ msg.timestamp|date:"h:i A" }}</span>
            </div>
        {% endfor %}
    </div>

    <div id="online-users-container" style="margin-bottom: 10px; padding: 10px; background: #eef; border-radius: 8px;">
        <div id="typing-indicator" style="font-size: 0.8em; color: gray; height: 20px; margin-left: 10px;"></div>
        <strong>Online Users:</strong>
        <ul id="online-users-list" style="display: flex; gap: 10px; list-style: none; padding: 0; margin-top: 5px;"></ul>
    </div>

    <br>

    <div class="chat-input-wrapper" style="position: sticky; bottom: 0; background: white; padding: 10px;">
        <div class="chat-input-container" style="display: flex; gap: 10px; align-items: center; background: #f1f1f1; padding: 5px 15px; border-radius: 30px;">
        
            <input type="file" id="chat-file-input" style="display: none;" accept="image/*">
            <label for="chat-file-input" style="cursor: pointer; font-size: 1.5rem; margin: 0; color: #666; display: flex; align-items: center;">üì∑</label>

            <button id="record-btn" type="button" style="background: none; border: none; cursor: pointer; font-size: 1.5rem; padding: 0; color: #666; display: flex; align-items: center;">üé§</button>

            <input id="chat-message-input" type="text" style="flex-grow: 1; border: none; padding: 10px; border-radius: 30px; outline: none; background: transparent;" placeholder="Type message...">
            
            <button id="chat-message-submit" type="button" class="btn btn-success" style="border-radius: 20px; padding: 5px 20px; background-color: #27ae60; color: white; border: none;">Send</button>
        </div>
    
        <div id="recording-status" style="display: none; color: red; font-size: 0.8rem; margin-left: 55px; font-weight: bold; margin-top: 5px;">
            üî¥ Recording...
        </div>

    </div>

    <div style="height: 100px;"></div>

    {{ room_name|json_script:"room-name" }}





<script>
    function urlify(text) {
        if (!text) return "";
        var urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, function(url) {
            return '<a href="' + url + '" target="_blank" style="color: #5887ff; text-decoration: underline;">' + url + '</a>';
        });
    }

    const roomName = JSON.parse(document.getElementById('room-name').textContent);
    const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + roomName + '/');
    const messageInputDom = document.querySelector('#chat-message-input');
    const typingDiv = document.querySelector('#typing-indicator');

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const currentUser = "{{ request.user.username }}";

        if (data.type === 'typing' && data.username !== currentUser) {
            typingDiv.innerText = data.username + ' is typing...';
            if (window.typingTimer) clearTimeout(window.typingTimer);
            window.typingTimer = setTimeout(() => { typingDiv.innerText = ''; }, 2000);
            return;
        }

        if (data.type === 'user_list') {
            const listElement = document.querySelector('#online-users-list');
            if (listElement) {
                listElement.innerHTML = ''; 
                data.users.forEach(user => {
                    const li = document.createElement('li');
                    li.style.cssText = "background: #d4edda; padding: 2px 8px; border-radius: 15px; font-size: 0.8em; border: 1px solid #c3e6cb;";
                    li.innerHTML = `‚óè ${user}`;
                    listElement.appendChild(li);
                });
            }
            return; 
        }
        
        if (data.type === 'chat_message') {
            const chatLog = document.querySelector('#chat-log');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${data.username === currentUser ? 'me' : 'other'}`;
            messageDiv.id = `msg-${data.message_id}`;

            let contentHTML = `<span class="username">${data.username}</span>`;

            if (data.image_url) {
                contentHTML += `<img src="${data.image_url}" style="max-width: 250px; border-radius: 10px; margin: 10px 0; display: block; cursor:pointer;" onclick="window.open('${data.image_url}')">`;
            } 
            
            // ‡¶Ö‡¶°‡¶ø‡¶ì ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞‡¶ø‡¶Ç
            if (data.audio_url) {
                contentHTML += 
                `<audio controls style="max-width: 100%; margin-top: 5px; display: block;">
                    <source src="${data.audio_url}" type="audio/wav">
                    Your browser does not support the audio element.
                </audio>`;
            }
            
            if (data.message) {
                contentHTML += `<span class="content">${urlify(data.message)}</span>`;
            }

            contentHTML += `
                <span class="timestamp">
                    ${data.timestamp}
                    <span class="tick" id="tick-${data.message_id}">
                        ${data.username === currentUser ? (data.is_read ? '‚úì‚úì' : '‚úì') : ''}
                    </span>
                </span>`;
            
            messageDiv.innerHTML = contentHTML;
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;

            if (data.username !== currentUser && data.message_id) {
                chatSocket.send(JSON.stringify({
                    'type': 'message_read',
                    'message_id': data.message_id
                }));
            }
        }
        
        if (data.type === 'message_read') {
            const tickElement = document.querySelector(`#tick-${data.message_id}`);
            if (tickElement) {
                tickElement.innerHTML = '‚úì‚úì'; 
                tickElement.style.color = '#3498db'; 
            }
        }
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    messageInputDom.focus();
    messageInputDom.onkeyup = function(e) {
        if (e.keyCode === 13) {
            document.querySelector('#chat-message-submit').click();
        } else {
            if (chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({ 'type': 'typing' }));
             }
        }
    }

    document.querySelector('#chat-message-submit').onclick = function(e){
        const message = messageInputDom.value;
        if (message.trim() !== ""){
            chatSocket.send(JSON.stringify({'message': message}));
            messageInputDom.value = '';
        }
    };

    const fileInput = document.querySelector('#chat-file-input');
    fileInput.onchange = function(e) {
        const file = fileInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            chatSocket.send(JSON.stringify({
                'type': 'file',
                'file_data': event.target.result,
                'file_name': file.name
            }));
        };
        reader.readAsDataURL(file);
        fileInput.value = ''; 
    };

    // ‡¶Ö‡¶°‡¶ø‡¶ì ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°‡¶ø‡¶Ç ‡¶≤‡¶ú‡¶ø‡¶ï (‡¶∏‡¶Ç‡¶∂‡ßã‡¶ß‡¶ø‡¶§)
    let mediaRecorder;
    let audioChunks = [];
    const recordBtn = document.getElementById('record-btn');
    const statusText = document.getElementById('recording-status');

    recordBtn.onclick = async () => {
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
                

                // ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°‡¶ø‡¶Ç ‡¶∂‡ßá‡¶∑ ‡¶π‡¶≤‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    
                    reader.onloadend = () => {  
                        const base64audio = reader.result;
                        if (chatSocket.readyState === WebSocket.OPEN){
                         chatSocket.send(JSON.stringify({
                            'type': 'audio',
                            'file_data': base64audio,
                         }));
                    } else {
                        console.error("WebSocket is not open. State: " + chatSocket.readyState);
                    }
                };

                 stream.getTracks().forEach(track => track.stop());
            };

                mediaRecorder.start();
                recordBtn.innerHTML = "üõë";
                if (statusText) statusText.style.display = "block";
            } catch (err) {
                alert("Microphone access denied or not available!");
            }
        } else {
            mediaRecorder.stop();
            recordBtn.innerHTML = "üé§";
            if (statusText) statusText.style.display = "none";
        }
    };
</script>
{% endblock %}

