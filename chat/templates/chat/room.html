
{% extends 'chat/base.html' %}
{% block title %}Room: {{ room_name }}{% endblock %}

{% block extra_css %}
    #chat-log { height:450px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; background-color: #fcfcfc; display: flex; flex-direction: column; gap: 10px; border-radius: 8px; }
    .message { padding: 8px 12px; background: #fff; border-radius: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); width: fit-content; max-width: 85%; word-wrap: break-word; }

    .message.me { align-self: flex-end; background-color: #81000f; border-bottom-right-radius: 2px; color: white; }
    .message.me .username { color: #e0e0e0; }
    .message.me .content { color: white; }

    .message.other { align-self: flex-start; background-color: #050027; border-bottom-left-radius: 2px; color: white; }
    .message.other .username { color: #ffe0e0; }
    .message.other .content { color: white; }

    .tick { font-size: 0.9em; margin-left: 5px; color: #aaa; }
    
    .username { font-weight: bold; display: block; font-size: 0.85em; }
    .timestamp { font-size: 0.7em; display: block; margin-top: 5px; opacity: 0.8; text-align: right; }
{% endblock %}

{% block content %}
    <h2>Room: {{ room_name }}</h2>
    <div id="chat-log">
        {% for msg in messages %}
            <div class="message {% if msg.user == request.user %}me{% else %}other{% endif %}">
                <span class="username">{{ msg.user.username }}</span>
                <span class="content">{{ msg.content }}</span>
                <span class="timestamp">{{ msg.timestamp|date:"h:i A" }}</span>
            </div>
        {% endfor %}
    </div>

    <div id="online-users-container" style="margin-bottom: 10px; padding: 10px; background: #eef; border-radius: 8px;">
        <div id="typing-indicator" style="font-size: 0.8em; color: gray; height: 20px; margin-left: 10px;"></div>
        <strong>Online Users:</strong>
        <ul id="online-users-list" style="display: flex; gap: 10px; list-style: none; padding: 0; margin-top: 5px;"></ul>
    </div>

    <br>
    <div style="display: flex; gap: 10px;">
        <input id="chat-message-input" type="text" style="flex-grow: 1; padding: 10px;" placeholder="Type message...">
        <input id="chat-message-submit" type="button" value="Send" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer;">
    </div>

    {{ room_name|json_script:"room-name" }}





    <script>
        const roomName = JSON.parse(document.getElementById('room-name').textContent);
        const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + roomName + '/');
        const messageInputDom = document.querySelector('#chat-message-input');
        const typingDiv = document.querySelector('#typing-indicator');

        chatSocket.onmessage = function(e){
            const data = JSON.parse(e.data);
            const currentUser = "{{ request.user.username }}";

            // ১. টাইপিং ইন্ডিকেটর
            if (data.type === 'typing' && data.username !== "{{ request.user.username }}"){
                typingDiv.innerText = data.username + ' is typing...';
                if (window.typingTimer) clearTimeout(window.typingTimer);
                window.typingTimer = setTimeout(() => { typingDiv.innerText = ''; }, 2000);
                return;
            }

            // ২. অনলাইন ইউজার লিস্ট
            if (data.type === 'user_list') {
                const listElement = document.querySelector('#online-users-list');
                if (listElement) {
                    listElement.innerHTML = ''; 
                    data.users.forEach(user => {
                        const li = document.createElement('li');
                        li.style.cssText = "background: #d4edda; padding: 2px 8px; border-radius: 15px; font-size: 0.8em; border: 1px solid #c3e6cb;";
                        li.innerHTML = `● ${user}`;
                        listElement.appendChild(li);
                    });
                }
                return; 
            }
            
            // ৩. চ্যাট মেসেজ
            if (data.message || data.type === 'chat_message'){
            const chatLog = document.querySelector('#chat-log');
            if (!document.getElementById(`msg-${data.message_id}`)){
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${data.username === currentUser ? 'me' : 'other'}`;
            messageDiv.id = `msg-${data.message_id}`;
            
            
            messageDiv.innerHTML = `
                <span class="username">${data.username}</span>
                <span class="content">${data.message}</span>
                <span class="timestamp">${data.timestamp}
                    <span class="tick" id="tick-${data.message_id}">
                        ${data.username === currentUser ? '✓' : ''}
                    </span>
                </span>
            `;
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        }
        
        if (data.username !== currentUser && data.message_id) {
            chatSocket.send(JSON.stringify({
                'type': 'message_read',
                'message_id': data.message_id
            }));
        }
    }
        
        if (data.type === 'message_read') {
            const tickElement = document.querySelector(`#tick-${data.message_id}`);
            if (tickElement) {
                tickElement.innerHTML = '✓✓'; 
                tickElement.style.color = '#3498db'; 
            }
        }

        messageInputDom.focus();

        messageInputDom.onkeyup = function(e) {
            if (e.keyCode === 13) {
                document.querySelector('#chat-message-submit').click();
            } else {
                chatSocket.send(JSON.stringify({ 'type': 'typing' }));
            }
        }
    };

        document.querySelector('#chat-message-submit').onclick = function(e){
            const message = messageInputDom.value;
            if (message.trim() !== ""){
                chatSocket.send(JSON.stringify({'message': message}));
                messageInputDom.value = '';
            }
        };
    </script>
{% endblock %}